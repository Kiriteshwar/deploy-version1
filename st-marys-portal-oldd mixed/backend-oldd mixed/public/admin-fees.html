<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Management - Admin - St. Mary's School</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="css/complaints.css">
    <link rel="stylesheet" href="/css/admin-fees.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .search-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .search-filters {
            display: grid;
            grid-template-columns: 200px 200px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .search-input-container {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        .search-input-container .form-group {
            flex: 1;
        }
        .search-input-container .submit-btn {
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .submit-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .submit-btn:hover {
            background: #0056b3;
        }
        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #007bff;
            padding: 10px 20px;
            border-radius: 4px;
            color: white;
            margin-bottom: 20px;
        }
        .details-header .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
        }
        .details-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        .discount-section {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .discount-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }
        .section-title {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 500;
        }
        .student-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }
        .student-details {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }
        .payment-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }
        .payment-history {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .fee-structure {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .fee-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .fee-item strong {
            display: block;
            margin-bottom: 5px;
            color: #007bff;
        }
        .search-results {
            margin-top: 20px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .receipt-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.4);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .receipt-modal-content {
            background: #fff;
            border-radius: 10px;
            padding: 30px 30px 20px 30px;
            max-width: 480px;
            width: 95vw;
            box-shadow: 0 4px 24px rgba(0,0,0,0.18);
            position: relative;
        }
        .close-receipt-modal {
            position: absolute;
            top: 12px;
            right: 18px;
            font-size: 1.5rem;
            color: #888;
            cursor: pointer;
        }
        .receipt-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 20px;
            justify-content: flex-end;
        }
        .view-receipt-link, .download-btn {
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 0.98em;
            margin: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            text-decoration: none;
            font-weight: 500;
        }
        .view-receipt-link:hover, .download-btn:hover {
            background: #0056b3;
            color: #fff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.15);
            transform: translateY(-1px) scale(1.03);
        }
        .fee-structure-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .fee-structure-table tr {
            border-bottom: 1px solid #eee;
        }
        .fee-structure-table td {
            padding: 10px;
        }
        .fee-structure-table .label {
            color: #666;
        }
        .fee-structure-table .value {
            text-align: right;
            font-weight: 500;
        }
        .fee-structure-table .total-row {
            border-top: 2px solid #ddd;
            font-weight: bold;
        }
        .fee-structure-table .discount-row {
            color: #28a745;
            font-weight: 600;
        }
        .fee-structure-table .final-fee-row {
            border-top: 2px solid #007bff;
            font-weight: bold;
            color: #007bff;
            background-color: #f8f9fa;
        }
        .payment-summary {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .payment-summary div {
            margin-bottom: 5px;
        }
        .search-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .search-group {
            display: flex;
            flex-direction: column;
        }
        .search-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .search-group select,
        .search-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-button {
            align-self: flex-end;
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            height: 38px;
            margin-top: 24px;
        }
        .search-button:hover {
            background: #0056b3;
        }
        .button-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .action-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        .view-btn {
            background: #007bff;
            color: white;
        }
        .view-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        .history-btn {
            background: #6c757d;
            color: white;
        }
        .history-btn:hover {
            background: #545b62;
            transform: translateY(-1px);
        }
        .button-group,
        .view-btn,
        .view-btn:hover,
        .history-btn,
        .history-btn:hover {
            display: none;
        }
        #payment-history-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #student-payment-history td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }
        #student-payment-history th {
            background-color: #f8f9fa;
            font-weight: 600;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 600px) {
            header {
                position: sticky !important;
                top: 0 !important;
                z-index: 1000 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
            }
            .container {
                padding: 0 2vw !important;
                max-width: 100vw !important;
            }
            .search-container {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
                padding: 15px !important;
            }
            .search-group select,
            .search-group input {
                font-size: 15px !important;
                padding: 10px !important;
            }
            .search-button {
                width: 100% !important;
                font-size: 1.05rem !important;
                padding: 14px 0 !important;
                border-radius: 6px !important;
                margin-top: 0 !important;
            }
            .dashboard-info, .student-list, .student-details, .payment-section, .payment-history {
                border-radius: 8px !important;
                padding: 15px !important;
                font-size: 15px !important;
                margin-bottom: 16px !important;
            }
            .data-table {
                width: 100vw !important;
                min-width: 600px !important;
                overflow-x: auto !important;
                display: block !important;
            }
            .data-table th, .data-table td {
                font-size: 13px !important;
                padding: 0.5rem 0.3rem !important;
            }
            .data-table th {
                position: sticky !important;
                top: 0 !important;
                z-index: 2 !important;
                background: #f8f9fa !important;
            }
            .action-buttons {
                flex-direction: column !important;
                gap: 8px !important;
            }
            .action-button {
                width: 100% !important;
                font-size: 1rem !important;
                padding: 12px 0 !important;
                border-radius: 6px !important;
                justify-content: center !important;
            }
            .btn, .submit-btn {
                width: 100% !important;
                font-size: 1.05rem !important;
                padding: 14px 0 !important;
                border-radius: 6px !important;
                margin-bottom: 8px !important;
            }
            .form-control, .form-select {
                font-size: 15px !important;
                padding: 10px !important;
            }
            .discount-form {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            .fee-structure {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            .fee-item {
                padding: 12px !important;
                font-size: 15px !important;
            }
            .details-header {
                flex-direction: column !important;
                gap: 10px !important;
                text-align: center !important;
            }
            .close-btn {
                align-self: center !important;
            }
            .receipt-modal-content {
                padding: 20px !important;
                margin: 10px !important;
            }
            .receipt-actions {
                flex-direction: column !important;
                gap: 10px !important;
            }
            .view-receipt-link, .download-btn {
                width: 100% !important;
                justify-content: center !important;
                font-size: 1rem !important;
                padding: 12px 0 !important;
            }
        }

        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        }

        .toast {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            margin-bottom: 10px;
            min-width: 300px;
            max-width: 400px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            pointer-events: auto;
            border-left: 4px solid #007bff;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left-color: #28a745;
        }

        .toast.error {
            border-left-color: #dc3545;
        }

        .toast.warning {
            border-left-color: #ffc107;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            color: #28a745;
        }

        .toast.error .toast-icon {
            color: #dc3545;
        }

        .toast.warning .toast-icon {
            color: #ffc107;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .toast-message {
            color: #666;
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: #666;
        }

        /* Mobile responsive toast */
        @media (max-width: 600px) {
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }
            .toast {
                min-width: 0;
                max-width: none;
                width: 100%;
            }
        }

        /* Loading Spinner Styles */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="header-left">
                <a href="dashboard.html" class="back-button">
                    <i class="fas fa-arrow-left"></i>
                    Return to Dashboard
                </a>
            </div>
            <div class="header-title">
                <h1><i class="fas fa-money-bill-wave"></i> Fee Management</h1>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Search Section -->
        <div class="search-container">
            <div class="search-group">
                <label for="class-select">Class</label>
                <select id="class-select">
                    <option value="">Select Class</option>
                </select>
            </div>
            <div class="search-group">
                <label for="section-select">Section</label>
                <select id="section-select">
                    <option value="">Select Section</option>
                </select>
            </div>
            <div class="search-group">
                <label for="search-input">Search</label>
                <input type="text" id="search-input" placeholder="Search by name or roll number">
            </div>
            <div class="search-group">
                <button class="search-button" onclick="searchStudents()">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>

        <!-- Student List -->
        <div id="student-list" class="dashboard-info" style="display: none;">
            <div class="loading-spinner" id="student-loading" style="display: none;"></div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Roll No</th>
                        <th>Name</th>
                        <th>Class</th>
                        <th>Section</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Student Details -->
        <div id="student-details" class="dashboard-info" style="display: none;">
            <div class="details-header">
                <h2 class="section-title" style="color: white; margin: 0;">Student Details</h2>
                <button onclick="closeDetails()" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="student-info" class="info-section"></div>
            
            <div id="fee-structure" class="info-section">
                <h3 class="section-title">Fee Structure</h3>
                <table id="fee-structure-table"></table>
            </div>

            <div id="discount-section" class="discount-section">
                <h3 class="section-title">Fee Discount</h3>
                <div class="discount-form">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Discount Amount</label>
                        <input type="number" id="discount-amount" class="form-control" placeholder="Enter discount amount">
                    </div>
                    <button onclick="updateDiscount()" class="submit-btn">
                        <i class="fas fa-save"></i> Update Discount
                    </button>
                </div>
            </div>

            <div id="payment-section" class="info-section">
                <h3 class="section-title">Make Payment</h3>
                <div class="form-group">
                    <label class="form-label">Amount</label>
                    <input type="number" id="payment-amount" class="form-control" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Mode</label>
                    <select id="payment-mode" class="form-select">
                        <option value="">Select Payment Mode</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Transaction ID</label>
                    <input type="text" id="transaction-id" class="form-control" placeholder="Transaction ID (optional)">
                </div>
                <div class="form-group">
                    <button onclick="makePayment()" class="submit-btn">
                        <i class="fas fa-check"></i> Make Payment
                    </button>
                </div>
            </div>

            <div id="payment-history-section" class="info-section">
                <h3 class="section-title">Payment History</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Receipt No</th>
                            <th>Amount</th>
                            <th>Mode</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="student-payment-history"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let currentStudentId = null;
        let currentPaymentData = null;

        // Toast Notification Functions
        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const iconMap = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            toast.innerHTML = `
                <i class="toast-icon ${iconMap[type] || iconMap.info}"></i>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(toast);

            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            // Auto remove after duration
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration);
        }

        // Load classes and sections on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadClassesAndSections();
            await loadPaymentModes();
        });

        async function loadClassesAndSections() {
            try {
                const response = await fetch('/api/teacher/classes', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch classes');
                
                const data = await response.json();
                const classSelect = document.getElementById('class-select');
                classSelect.innerHTML = '<option value="">Select Class</option>';
                
                if (data && data.classes) {
                    data.classes.sort().forEach(cls => {
                        classSelect.innerHTML += `<option value="${cls}">${cls}</option>`;
                    });
                }

                // Add event listener for class change
                classSelect.addEventListener('change', async () => {
                    const selectedClass = classSelect.value;
                    const sectionSelect = document.getElementById('section-select');
                    sectionSelect.innerHTML = '<option value="">Select Section</option>';
                    
                    if (selectedClass) {
                        try {
                            const sectionsResponse = await fetch(`/api/teacher/sections/${selectedClass}`, {
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                                }
                            });
                            
                            if (!sectionsResponse.ok) throw new Error('Failed to fetch sections');
                            
                            const sectionsData = await sectionsResponse.json();
                            if (Array.isArray(sectionsData)) {
                                sectionsData.sort().forEach(section => {
                                    sectionSelect.innerHTML += `<option value="${section}">${section}</option>`;
                                });
                            }
                        } catch (error) {
                            console.error('Error loading sections:', error);
                        }
                    }
                });

                // Add event listener for section change
                const sectionSelect = document.getElementById('section-select');
                sectionSelect.addEventListener('change', () => {
                    const selectedClass = classSelect.value;
                    const selectedSection = sectionSelect.value;
                    
                    // If both class and section are selected, trigger search
                    if (selectedClass && selectedSection) {
                        searchStudents();
                    }
                });
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function loadPaymentModes() {
            const paymentModeSelect = document.getElementById('payment-mode');
            paymentModeSelect.innerHTML = `
                <option value="">Select Payment Mode</option>
                <option value="cash">Cash</option>
                <option value="online">Online</option>
                <option value="cheque">Cheque</option>
            `;
        }

        async function searchStudents() {
            const className = document.getElementById('class-select').value;
            const section = document.getElementById('section-select').value;
            const search = document.getElementById('search-input').value;
            const loadingSpinner = document.getElementById('student-loading');
            const studentList = document.getElementById('student-list');

            try {
                loadingSpinner.style.display = 'flex';
                studentList.style.display = 'block';
                document.getElementById('student-details').style.display = 'none';

                // Build query parameters
                const queryParams = new URLSearchParams();
                if (className) queryParams.append('class', className);
                if (section) queryParams.append('section', section);
                if (search) queryParams.append('search', search);

                const response = await fetch(`/api/admin/fees/students?${queryParams.toString()}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch students');
                
                const students = await response.json();
                const tbody = document.getElementById('student-list').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';

                if (!students || students.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5">
                                <div class="empty-state">
                                    <i class="fas fa-user-slash"></i>
                                    <h3>No students found</h3>
                                    <p>Try different search criteria</p>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    students.forEach(student => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${student.studentInfo?.rollNumber || 'STU' + student._id.slice(-3)}</td>
                            <td>${student.name || '-'}</td>
                            <td>${student.studentInfo?.class || className || '-'}</td>
                            <td>${student.studentInfo?.section || section || '-'}</td>
                            <td class="action-buttons">
                                <button onclick="viewStudent('${student._id}')" class="action-button respond">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                                <button onclick="viewPaymentHistory('${student._id}')" class="action-button resolve">
                                    <i class="fas fa-history"></i> Payment History
                                </button>
                            </td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error searching students:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h3>Error</h3>
                                <p>${error.message}</p>
                            </div>
                        </td>
                    </tr>
                `;
            } finally {
                loadingSpinner.style.display = 'none';
            }
        }

        function renderStudentInfo(student) {
            const studentInfo = document.getElementById('student-info');
            let infoHTML = '';
            
            // Student basic information
            const basicFields = {
                name: 'Name',
                class: 'Class',
                section: 'Section',
                rollNumber: 'Roll Number'
            };

            Object.entries(basicFields).forEach(([key, label]) => {
                const value = student[key] || student.studentInfo?.[key] || '-';
                infoHTML += `
                    <div class="info-row">
                        <span class="label">${label}:</span>
                        <span class="value">${value}</span>
                    </div>`;
            });

            // Guardian and address information
            const guardianFields = {
                guardianName: 'Guardian Name',
                guardianPhone: 'Guardian Phone',
                address: 'Address'
            };

            Object.entries(guardianFields).forEach(([key, label]) => {
                const value = student[key] || student.studentInfo?.[key] || '-';
                infoHTML += `
                    <div class="info-row">
                        <span class="label">${label}:</span>
                        <span class="value">${value}</span>
                    </div>`;
            });

            studentInfo.innerHTML = infoHTML;
        }

        async function renderFeeStructure(feeStructure, discount = 0) {
            const feeStructureTable = document.getElementById('fee-structure-table');
            let feeRows = '';
            let totalFee = 0;

            if (feeStructure) {
                // Dynamically get all fee components from the fee structure
                const excludeFields = ['_id', '__v', 'class', 'academicYear', 'totalFee', 'dueDate', 'createdAt', 'updatedAt'];
                const feeComponents = {};
                
                // Extract all fee components dynamically
                Object.keys(feeStructure).forEach(key => {
                    if (!excludeFields.includes(key) && typeof feeStructure[key] === 'number' && key.toLowerCase().includes('fee')) {
                        feeComponents[key] = feeStructure[key] || 0;
                    }
                });

                // Use totalFee from backend if available, otherwise calculate from components
                totalFee = feeStructure.totalFee || Object.values(feeComponents).reduce((sum, fee) => sum + (fee || 0), 0);

                // Display individual fee components
                Object.entries(feeComponents).forEach(([key, value]) => {
                    // Convert camelCase to readable format
                    const feeLabel = key.replace(/([A-Z])/g, ' $1')
                                      .replace(/^./, str => str.toUpperCase())
                                      .replace(/Fee$/, ' Fee'); // Only replace 'Fee' at the end
                    
                    feeRows += `<tr>
                        <td class="label">${feeLabel}</td>
                        <td class="value">₹${value || 0}</td>
                    </tr>`;
                });

                // Add total fee row (before discount)
                feeRows += `<tr class="total-row">
                    <td class="label">Total Fee (Before Discount)</td>
                    <td class="value">₹${totalFee}</td>
                </tr>`;

                // Add discount row if applicable
                if (discount > 0) {
                    // Validate discount doesn't exceed total fee
                    const validDiscount = Math.min(discount, totalFee);
                    feeRows += `<tr class="discount-row">
                        <td class="label">Discount</td>
                        <td class="value">- ₹${validDiscount}</td>
                    </tr>`;
                    
                    // Add final fee row (after discount)
                    const finalFee = totalFee - validDiscount;
                    feeRows += `<tr class="final-fee-row">
                        <td class="label">Final Fee (After Discount)</td>
                        <td class="value">₹${finalFee}</td>
                    </tr>`;
                } else {
                    // If no discount, final fee is same as total fee
                    feeRows += `<tr class="final-fee-row">
                        <td class="label">Final Fee</td>
                        <td class="value">₹${totalFee}</td>
                    </tr>`;
                }
            }
            
            feeStructureTable.innerHTML = feeRows;
            return totalFee;
        }

        function renderPaymentSummary(payment) {
            if (!payment) return '';

            const summaryFields = {
                totalPaid: 'Total Paid',
                balance: 'Balance',
                dueDate: 'Due Date',
                status: 'Status'
            };

            let summaryHTML = `<div class="payment-summary">
                <h4 style="margin-top:0;margin-bottom:10px;">Payment Summary</h4>`;

            Object.entries(summaryFields).forEach(([key, label]) => {
                let value = payment[key];
                if (key === 'dueDate' && value) {
                    value = new Date(value).toLocaleDateString();
                } else if (key === 'totalPaid' || key === 'balance') {
                    value = `₹${value || 0}`;
                } else if (key === 'status') {
                    value = value.charAt(0).toUpperCase() + value.slice(1);
                }
                summaryHTML += `<div><strong>${label}:</strong> ${value || '-'}</div>`;
            });

            summaryHTML += '</div>';
            return summaryHTML;
        }

        async function viewStudent(studentId) {
            try {
                const response = await fetch(`/api/admin/fees/student/${studentId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch fee details: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Render student info
                renderStudentInfo(data.student);

                // Clear existing fee structure and payment summary
                document.getElementById('fee-structure').innerHTML = '<table id="fee-structure-table"></table>';
                
                // Display fee structure with discount
                if (data.feeStructure) {
                    await renderFeeStructure(data.feeStructure, data.student.discount || 0);
                }

                // Use the payment record from database for consistent values
                if (data.payments && data.payments.length > 0) {
                    const paymentRecord = data.payments[0];
                    const summaryBox = document.createElement('div');
                    summaryBox.innerHTML = renderPaymentSummary({
                        totalPaid: paymentRecord.totalPaid || 0,
                        balance: paymentRecord.balance || 0,
                        dueDate: paymentRecord.dueDate,
                        status: paymentRecord.status || 'pending'
                    });
                    document.getElementById('fee-structure').appendChild(summaryBox);
                } else if (data.feeStructure) {
                    // If no payment records yet, show summary with initial balance
                    const summaryBox = document.createElement('div');
                    // Use totalFee from fee structure (calculated on backend) or calculate from components
                    let totalFee = data.feeStructure.totalFee;
                    if (!totalFee) {
                        // Fallback: calculate from components if totalFee is missing
                        const excludeFields = ['_id', '__v', 'class', 'academicYear', 'totalFee', 'dueDate', 'createdAt', 'updatedAt'];
                        const feeComponents = {};
                        Object.keys(data.feeStructure).forEach(key => {
                            if (!excludeFields.includes(key) && typeof data.feeStructure[key] === 'number' && key.toLowerCase().includes('fee')) {
                                feeComponents[key] = data.feeStructure[key] || 0;
                            }
                        });
                        totalFee = Object.values(feeComponents).reduce((sum, fee) => sum + (fee || 0), 0);
                    }
                    const totalToBePaid = totalFee - (data.student.discount || 0);
                    summaryBox.innerHTML = renderPaymentSummary({ 
                        totalPaid: 0, 
                        balance: totalToBePaid, 
                        dueDate: data.feeStructure.dueDate, 
                        status: 'pending'
                    });
                    document.getElementById('fee-structure').appendChild(summaryBox);
                }

                // Show student details section
                document.getElementById('student-details').style.display = 'block';
                document.getElementById('student-list').style.display = 'none';

                // Store current student ID
                currentStudentId = studentId;

                // Show all sections except payment history
                document.getElementById('fee-structure').style.display = 'block';
                document.getElementById('discount-section').style.display = 'block';
                document.getElementById('payment-section').style.display = 'block';
                document.getElementById('payment-history-section').style.display = 'none';

                // Set current discount in input
                document.getElementById('discount-amount').value = data.student.discount || '';

            } catch (error) {
                console.error('Error fetching student details:', error);
                showToast('error', 'Error', `Failed to fetch student details: ${error.message}`);
            }
        }

        async function viewPaymentHistory(studentId) {
            try {
                const response = await fetch(`/api/admin/fees/student/${studentId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch payment history: ${response.status}`);
                }

                const data = await response.json();

                // Show student details section with payment history
                document.getElementById('student-details').style.display = 'block';
                document.getElementById('student-list').style.display = 'none';

                // Store current student ID
                currentStudentId = studentId;

                // Update student info section with complete details
                renderStudentInfo(data.student);

                // Hide other sections and show payment history
                document.getElementById('fee-structure').style.display = 'none';
                document.getElementById('discount-section').style.display = 'none';
                document.getElementById('payment-section').style.display = 'none';
                document.getElementById('payment-history-section').style.display = 'block';

                // Update payment history table with student fee page style
                const tbody = document.getElementById('student-payment-history');
                tbody.innerHTML = '';

                if (!data.payments || data.payments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5"><em>No payments found.</em></td></tr>';
                    return;
                }

                data.payments.forEach(doc => {
                    if (doc.payments && doc.payments.length > 0) {
                        doc.payments.forEach((pay, idx) => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${pay.paymentDate ? new Date(pay.paymentDate).toLocaleDateString() : '-'}</td>
                                <td>${pay.receipt?.number || 'N/A'}</td>
                                <td>₹${pay.amount || '-'}</td>
                                <td>${pay.paymentMode || '-'}</td>
                                <td>
                                    <button onclick='viewReceipt(${JSON.stringify(doc)}, ${idx})' class="view-receipt-link">
                                        <i class="fas fa-eye"></i> View Receipt
                                    </button>
                                    <button onclick='downloadReceipt(${JSON.stringify(doc)}, ${idx})' class="download-btn">
                                        <i class="fas fa-download"></i> Download Receipt
                                    </button>
                                </td>
                            `;
                        });
                    }
                });

            } catch (error) {
                console.error('Error fetching payment history:', error);
                showToast('error', 'Error', `Failed to fetch payment history: ${error.message}`);
            }
        }

        function formatAmount(num) {
            if (num === null || num === undefined || isNaN(num)) {
                return '0';
            }
            return Number(num).toLocaleString('en-IN', { maximumFractionDigits: 2 });
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
        }

        function generateReceiptPDF(doc, pay, openInNewWindow = false) {
            try {
                const student = getStudentInfoFromPage();
                const docPDF = new window.jspdf.jsPDF();
                
                // Modern color scheme
                const primaryColor = [0, 123, 255]; // Blue
                const secondaryColor = [108, 117, 125]; // Gray
                const successColor = [40, 167, 69]; // Green
                const backgroundColor = [248, 249, 250]; // Light gray
                const borderColor = [220, 224, 229]; // Light border

                // Modern header background
                docPDF.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                docPDF.rect(0, 0, 210, 50, 'F');
                
                // White content area with shadow effect
                docPDF.setFillColor(255, 255, 255);
                docPDF.rect(10, 45, 190, 240, 'F');
                docPDF.setDrawColor(borderColor[0], borderColor[1], borderColor[2]);
                docPDF.setLineWidth(1);
                docPDF.rect(10, 45, 190, 240, 'S');

                // School Logo and Header
                try {
                    docPDF.addImage('images/logo.jpg', 'JPEG', 20, 8, 30, 30);
                } catch (logoError) {
                    console.warn('Logo not found, continuing without logo');
                }
                
                // School Name and Header Info
                docPDF.setFont('helvetica', 'bold');
                docPDF.setFontSize(24);
                docPDF.setTextColor(255, 255, 255);
                docPDF.text("St. Mary's High School", 55, 20);
                
                docPDF.setFont('helvetica', 'normal');
                docPDF.setFontSize(10);
                docPDF.text('Hasanparthy, Dist: Hanamkonda, Telangana - 506371', 55, 28);
                docPDF.text('Phone: +91-9999999999 | Email: infostmarysscl@gmail.com', 55, 35);

                // Receipt Title with background
                docPDF.setFillColor(successColor[0], successColor[1], successColor[2]);
                docPDF.roundedRect(15, 55, 180, 15, 3, 3, 'F');
                docPDF.setFont('helvetica', 'bold');
                docPDF.setFontSize(16);
                docPDF.setTextColor(255, 255, 255);
                docPDF.text('OFFICIAL FEE PAYMENT RECEIPT', 105, 65, { align: 'center' });

                // Receipt details box
                let y = 85;
                docPDF.setFillColor(backgroundColor[0], backgroundColor[1], backgroundColor[2]);
                docPDF.roundedRect(15, y - 5, 180, 20, 2, 2, 'F');
                
                docPDF.setFont('helvetica', 'bold');
                docPDF.setFontSize(11);
                docPDF.setTextColor(0, 0, 0);
                
                if (pay.receipt && pay.receipt.number) {
                    docPDF.text(`Receipt No: ${pay.receipt.number}`, 20, y + 3);
                }
                docPDF.text(`Date: ${formatDateTime(pay.paymentDate).split(' ')[0]}`, 130, y + 3);
                docPDF.text(`Time: ${formatDateTime(pay.paymentDate).split(' ')[1]}`, 130, y + 10);
                docPDF.text(`Academic Year: ${new Date().getFullYear()}-${new Date().getFullYear() + 1}`, 20, y + 10);

                // Student Information Section
                y = 115;
                docPDF.setFont('helvetica', 'bold');
                docPDF.setFontSize(14);
                docPDF.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                docPDF.text('STUDENT INFORMATION', 20, y);
                
                // Student info table
                y += 8;
                docPDF.setDrawColor(borderColor[0], borderColor[1], borderColor[2]);
                docPDF.setLineWidth(0.5);
                
                const studentData = [
                    ['Student Name', student.name || doc.studentName || doc.student?.name || 'N/A'],
                    ['Class & Section', `${student.class || doc.class || 'N/A'} - ${student.section || doc.section || 'N/A'}`],
                    ['Roll Number', student.rollNumber || doc.rollNumber || doc.student?.rollNumber || 'N/A'],
                    ['Payment Mode', pay.paymentMode || 'N/A'],
                    ['Transaction ID', pay.transactionId || 'N/A']
                ];
                
                docPDF.setFont('helvetica', 'normal');
                docPDF.setFontSize(10);
                docPDF.setTextColor(0, 0, 0);
                
                studentData.forEach((row, index) => {
                    const rowY = y + (index * 12);
                    if (index % 2 === 0) {
                        docPDF.setFillColor(255, 255, 255);
                    } else {
                        docPDF.setFillColor(backgroundColor[0], backgroundColor[1], backgroundColor[2]);
                    }
                    docPDF.rect(15, rowY - 2, 180, 12, 'F');
                    docPDF.rect(15, rowY - 2, 180, 12, 'S');
                    
                    docPDF.setFont('helvetica', 'bold');
                    docPDF.text(row[0], 20, rowY + 6);
                    docPDF.setFont('helvetica', 'normal');
                    docPDF.text(row[1], 100, rowY + 6);
                });

                // Payment Details Section
                y += 80;
                docPDF.setFont('helvetica', 'bold');
                docPDF.setFontSize(14);
                docPDF.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                docPDF.text('PAYMENT DETAILS', 20, y);

                // Amount paid highlight box
                y += 12;
                docPDF.setFillColor(successColor[0], successColor[1], successColor[2]);
                docPDF.roundedRect(15, y - 5, 180, 25, 3, 3, 'F');
                
                docPDF.setFont('helvetica', 'bold');
                docPDF.setFontSize(18);
                docPDF.setTextColor(255, 255, 255);
                docPDF.text('AMOUNT PAID', 35, y + 10);
                docPDF.setFontSize(24);
                const amountValue = Number(pay.amount) || 0;
                const amountPaidText = `Rs.${amountValue.toLocaleString('en-IN')}`;
                docPDF.setCharSpace(0); // Remove any extra character spacing
                docPDF.text(amountPaidText, 175, y+10,{ align: 'right' });

                // Balance information
                y += 35;
                // Use balance at payment time if available, otherwise use current balance
                let balanceAtPayment;
                let balanceLabel;
                if (pay.balanceAfterPayment !== undefined && pay.balanceAfterPayment !== null) {
                    balanceAtPayment = pay.balanceAfterPayment;
                    balanceLabel = 'Balance Due:';
                } else {
                    balanceAtPayment = doc.balance || 0;
                    balanceLabel = 'Current Balance Due:';
                }
                
                docPDF.setFillColor(backgroundColor[0], backgroundColor[1], backgroundColor[2]);
                docPDF.roundedRect(15, y - 5, 180, 20, 2, 2, 'F');
                
                docPDF.setFont('helvetica', 'bold');
                docPDF.setFontSize(12);
                docPDF.setTextColor(0, 0, 0);
                docPDF.text(balanceLabel, 35, y + 3);
                if (balanceAtPayment > 0) {
                    docPDF.setTextColor(220, 53, 69);
                } else {
                    docPDF.setTextColor(successColor[0], successColor[1], successColor[2]);
                }
                const balanceValue = Number(balanceAtPayment) || 0;
                const balanceText = `Rs.${balanceValue.toLocaleString('en-IN')}`;
                docPDF.setCharSpace(0); // Remove any extra character spacing
                docPDF.text(balanceText, 175, y+3,{ align: 'right' });
                
                if (balanceAtPayment <= 0) {
                    docPDF.setTextColor(successColor[0], successColor[1], successColor[2]);
                    docPDF.setCharSpace(0); // Remove any extra character spacing
                    docPDF.text('FULLY PAID', 35, y + 12);
                }

                // Status and Due Date
                y += 25;
                if (doc.dueDate) {
                    docPDF.setFont('helvetica', 'normal');
                    docPDF.setFontSize(10);
                    docPDF.setTextColor(secondaryColor[0], secondaryColor[1], secondaryColor[2]);
                    docPDF.text(`Fee Due Date: ${formatDateTime(doc.dueDate).split(' ')[0]}`, 20, y);
                }

                if (doc.status === 'overdue' && balanceAtPayment > 0) {
                    docPDF.setFillColor(220, 53, 69);
                    docPDF.roundedRect(15, y + 5, 180, 15, 2, 2, 'F');
                    docPDF.setFont('helvetica', 'bold');
                    docPDF.setFontSize(12);
                    docPDF.setTextColor(255, 255, 255);
                    docPDF.text('⚠ OVERDUE - Please clear remaining balance immediately', 20, y + 13);
                    y += 20;
                }

                // Remove watermark as requested

                // Footer
                const footerY = 265;
                docPDF.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                docPDF.rect(0, footerY, 210, 32, 'F');
                
                docPDF.setFont('helvetica', 'normal');
                docPDF.setFontSize(9);
                docPDF.setTextColor(255, 255, 255);
                docPDF.text('This is a computer-generated receipt and does not require a signature.', 15, footerY + 8);
                docPDF.text('For any queries, please contact the school office during working hours.', 15, footerY + 15);
                docPDF.text(`Generated on: ${formatDateTime(new Date())}`, 15, footerY + 22);
                
                // Thank you message - properly positioned
                docPDF.setFont('helvetica', 'bold');
                docPDF.setFontSize(10);
                docPDF.text('Thank you for your payment!', 195, footerY + 18, { align: 'right' });

                // Security features
                docPDF.setFont('helvetica', 'normal');
                docPDF.setFontSize(6);
                docPDF.setTextColor(200, 200, 200);
                const securityCode = `Security Code: ${pay.receipt?.number || 'TEMP'}-${Date.now().toString().slice(-6)}`;
                docPDF.text(securityCode, 190, footerY - 9, { align: 'right' });

                // Output
                if (openInNewWindow) {
                    docPDF.output('dataurlnewwindow');
                } else {
                    const filename = `St_Marys_Receipt_${pay.receipt?.number || Date.now()}_${student.name?.replace(/\s+/g, '_') || 'Student'}.pdf`;
                    docPDF.save(filename);
                }
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate receipt. Please try again.');
            }
        }

        function viewReceipt(doc, pay) {
            generateReceiptPDF(doc, pay, true);
        }

        function downloadReceipt(doc, pay) {
            generateReceiptPDF(doc, pay, false);
        }


        function getStudentInfoFromPage() {
            const infoDiv = document.getElementById('student-info');
            if (!infoDiv) return {};
            
            const name = infoDiv.querySelector('.value')?.textContent || '';
            const classSection = infoDiv.querySelectorAll('.value')[1]?.textContent || '';
            const section = infoDiv.querySelectorAll('.value')[2]?.textContent || '';
            const rollNumber = infoDiv.querySelectorAll('.value')[3]?.textContent || '';
            
            return { 
                name, 
                class: classSection, 
                section, 
                rollNumber 
            };
        }

        async function makePayment() {
            if (!currentStudentId) {
                showToast('error', 'Error', 'No student selected');
                return;
            }

            const amount = document.getElementById('payment-amount').value;
            const paymentMode = document.getElementById('payment-mode').value;
            const transactionId = document.getElementById('transaction-id').value;

            if (!amount || !paymentMode) {
                showToast('error', 'Error', 'Please fill in all required fields');
                return;
            }

            // Show loading state
            const submitBtn = document.querySelector('#payment-section .submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading-spinner"></div>Processing...';
            submitBtn.classList.add('btn-loading');

            try {
                const response = await fetch(`/api/admin/fees/pay/${currentStudentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        paymentMode,
                        transactionId: transactionId || undefined
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to make payment');
                }

                const result = await response.json();
                showToast('success', 'Success', 'Payment made successfully!');
                
                // Clear form
                document.getElementById('payment-amount').value = '';
                document.getElementById('payment-mode').value = '';
                document.getElementById('transaction-id').value = '';
                
                // Refresh student details to show updated payment history
                await viewStudent(currentStudentId);
                
            } catch (error) {
                console.error('Error making payment:', error);
                showToast('error', 'Error', `Failed to make payment: ${error.message}`);
            } finally {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.classList.remove('btn-loading');
            }
        }

        async function updateDiscount() {
            if (!currentStudentId) {
                showToast('error', 'Error', 'No student selected');
                return;
            }

            const discount = document.getElementById('discount-amount').value;

            if (discount === '' || discount < 0) {
                showToast('error', 'Error', 'Please enter a valid discount amount');
                return;
            }

            // Get the total fee from the fee structure table to validate discount
            const feeStructureTable = document.getElementById('fee-structure-table');
            const totalFeeRow = feeStructureTable.querySelector('.total-row .value');
            if (totalFeeRow) {
                const totalFee = parseFloat(totalFeeRow.textContent.replace('₹', '').replace(',', ''));
                if (discount > totalFee) {
                    showToast('error', 'Error', `Discount amount (₹${discount}) cannot exceed total fee (₹${totalFee})`);
                    return;
                }
            }

            // Show loading state
            const submitBtn = document.querySelector('#discount-section .submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading-spinner"></div>Updating...';
            submitBtn.classList.add('btn-loading');

            try {
                const response = await fetch(`/api/admin/fees/discount/${currentStudentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify({
                        discount: parseFloat(discount)
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update discount');
                }

                const result = await response.json();
                showToast('success', 'Success', 'Discount updated successfully!');
                
                // Refresh student details to show updated fee structure
                await viewStudent(currentStudentId);
                
            } catch (error) {
                console.error('Error updating discount:', error);
                showToast('error', 'Error', `Failed to update discount: ${error.message}`);
            } finally {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.classList.remove('btn-loading');
            }
        }

        function closeDetails() {
            document.getElementById('student-details').style.display = 'none';
            document.getElementById('student-list').style.display = 'block';
            currentStudentId = null;
        }
    </script>
</body>
</html> 